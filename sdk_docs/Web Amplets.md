- A concept for [[trusted-in-untrusted [[Secure UI]]]] using [[iframes]] by [[Michael Fig]].
- [Original Google Doc](https://docs.google.com/document/d/17zKtAyOpwCBDQDIyzLIUxUUENTA7lU753suyP_onefU/edit)
- Original text
    - # Web Amplets
    - Note: these aren’t exactly “caplets” (which provide isolation between a trusted embedder and untrusted components).  Instead, these are more like “reverse web caplets”, which allow trusted components to run in a trusted host (the user’s browser) but within an untrusted embedder (such as a random website) without that embedder interfering with their operation.
        - Web Amplets are granular UI components that have access to greater authority than their embedder.  Web Amplets thrive in a pure-ocap system, but that is not a necessary condition.
        - Four key technologies have arrived to enable harmonious use on the Web:
            - Same-origin policy: Web Amplets are each hosted in an iframe from a privileged origin (such as http://localhost:8000) for battle-tested browser isolation from other origin web sites.  This is a simpler architecture (though more heavyweight) to bootstrap implementation in browsers rather than a browser extension, or DOM-membranes.
            - CapTP/delegated Promises as the host-agnostic glue that enables communication over postMessage, WebSocket, HTTP, WebRTC Data Channels, or others.  The main benefit is security and boundary traversal without having to write manual message routes.  For layered defenses, the Amplet’s backend can also enforce same-origin restrictions in order to prevent access from anything except its own Amplets.
            - UI written in rich, idiomatic HTML5/CSS/SVG/whatever web technologies you like.  No need to compartmentalise unless explicitly desired.
            - A language-specific, but whose concepts are portable, runtime library.  External things are only acted upon by object references.  Internal and interface (aka kernel) things have their own structure that should be abstracted in order to provide a comprehensible architecture.
    - ## The [[Agoric]] Wallet
    - This section is greatly inspired by [[Dan Finlay]]’s application of these concepts to an experimental branch of [[MetaMask]].
        - What if the wallet was refactored into Amplets?  The Amplets can interact with the dapp over postmessage, and to other Amplets via the dapp.  Amplets from the same origin have more flexibility in the protocols they use to communicate (any Web technology is fair game), but for example, we might never give the purse balances or petnames to the dapp.  Instead, the dapp says “I want a purse selector Amplet *here*, and I pass it references for a public set of brandregkeys.  I also want an amount Amplet (which I introduce to the other Amplet) *there*, configured to require at least *this* amount (expressed in terms of my favourite issuer’s amountmath).”  The dapp doesn’t get information about the selections until its API server is notified by its contract of actual offers made via Zoe.  The Amplets don’t get any information from the dapp except what it wants to share, and the user interacting directly with the Amplet.
        - A proof-of-concept shows that I can drag-and-drop an item from one Amplet (Alice) to another Amplet (Bob), both embedded in Mallet’s dapp page, but Mallet cannot intercept the communication.  I communicate with the dapp page via postmessage, and the wallet backend via WebSocket, both of which are easily restricted using existing Web technologies.
        - Even if somebody creates a “trojan Amplet”, the user cannot give excess authority to the trojan because same-origin policy prevents the trojan from doing anything except what the origin’s Amplets allow (since the wallet only accepts inbound connections from its own Amplets).  Clickjacking is fruitless, since the dapp programmer can’t gain any useful information from the wallet backend.  The “submit offer” Amplet, however, can tie this state together to construct an actual offer, which the user can then approve with the “wallet user” component.
        - Note that, to prevent phishing attacks, it is important not to have an Amplet interact with the user in a way that reveals secrets (such as passwords) to the Amplet.
        - It’s easier to audit these individual components for correctness.  It also simplifies the UX from having to configure limits and representations of what amounts and purses they want the dapp to access, to instead just single-source-of-truth opaque components.
        - The main user page for the wallet can be one frame which takes advantage of Compartments to host separate Amplets rather than iframes, since there are finer-grained security mechanisms useable when embedding the components you host.  Akin to a microkernel transferring processes it mutually trusts into its own address space for efficiency, leaving the sensitive ones outside, but nobody else but the microkernel itself has the ability to relax the boundaries.
